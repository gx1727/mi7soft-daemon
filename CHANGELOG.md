# Changelog

All notable changes to this project will be documented in this file.

## [Unreleased] - 2026-02-28

### Added - 路径 A: 核心功能增强

#### 统一日志系统（第一步）
- ✅ 添加 tracing 日志框架
  - tracing = "0.1"
  - tracing-subscriber (with env-filter, fmt, json features)
  - tracing-appender = "0.2"

- ✅ 初始化结构化日志系统
  - 支持环境变量配置日志级别（RUST_LOG）
  - 默认 info 级别
  - 支持模块级别控制

- ✅ 替换日志输出
  - main.rs: 添加 init_tracing() 函数
  - daemon.rs: 替换所有 eprintln! 为 tracing 宏
  - 添加结构化日志字段（process, pid, error 等）

#### 进程输出捕获（第二步）
- ✅ 新增 process_output.rs 模块
  - OutputCapture - 捕获进程 stdout/stderr
  - LogViewer - 日志查看器
  - 支持功能：
    - 捕获输出到文件
    - tail() - 查看最后 N 行
    - follow() - 实时跟踪（类似 tail -f）
    - since() - 按时间过滤

- ✅ 更新配置系统
  - capture_output 字段（默认 true）
  - max_log_size 字段（日志文件大小限制）

- ✅ 新增 CLI 命令
  - `logs <name>` - 查看进程日志
  - `logs <name> --follow` - 实时跟踪日志
  - `logs <name> --lines N` - 查看最后 N 行
  - `logs <name> --since S` - 查看最近 S 秒的日志

- ✅ 添加 chrono 依赖（时间处理）

#### 持久化存储（第三步）
- ✅ 新增 storage.rs 模块
  - Storage 管理器（基于 SQLite）
  - 数据模型：
    - ProcessHistory - 进程历史记录
    - ProcessStats - 进程统计信息
  - 核心功能：
    - record_start() - 记录进程启动
    - record_end() - 记录进程结束
    - record_restart() - 记录进程重启
    - get_history() - 查询历史记录
    - get_stats() - 查询统计信息
    - cleanup_old_records() - 清理旧记录

- ✅ 数据库设计
  - process_history 表（历史记录）
  - process_stats 表（统计信息）

- ✅ 新增 CLI 命令
  - `history <name>` - 查看进程历史
  - `history <name> --number N` - 查看最近 N 条记录
  - `stats <name>` - 查看进程统计
  - `stats` - 查看所有进程统计

- ✅ 添加 rusqlite 依赖（SQLite 数据库）

### Changed

- 改进日志可追溯性
- 统一日志格式
- 支持日志级别动态控制
- 增强配置验证
- 改进错误处理

### Usage

#### 日志系统
```bash
# 默认 info 级别
mi7soft-daemon start

# debug 级别
RUST_LOG=debug mi7soft-daemon start

# 特定模块
RUST_LOG=mi7soft_daemon::daemon=debug mi7soft-daemon start
```

#### 进程日志
```bash
# 查看日志
mi7soft-daemon logs web-server

# 实时跟踪
mi7soft-daemon logs web-server --follow

# 查看最近 50 行
mi7soft-daemon logs web-server --lines 50

# 查看最近 1 小时的日志
mi7soft-daemon logs web-server --since 3600
```

#### 历史和统计
```bash
# 查看历史
mi7soft-daemon history web-server
mi7soft-daemon history web-server --number 20

# 查看统计
mi7soft-daemon stats web-server
mi7soft-daemon stats  # 所有进程
```

### Configuration

新增配置字段：

```toml
[[processes]]
name = "web-server"
command = "/usr/bin/python -m http.server 8000"
capture_output = true           # 是否捕获输出（默认 true）
log_file = "/var/log/web.log"   # 日志文件路径
max_log_size = 10485760         # 最大日志文件大小（字节）
auto_restart = true
```

### Dependencies

新增依赖：
- tracing = "0.1"
- tracing-subscriber = { version = "0.3", features = ["env-filter", "fmt", "json"] }
- tracing-appender = "0.2"
- chrono = "0.4"
- rusqlite = { version = "0.31", features = ["bundled"] }

### Files Changed

**新增文件：**
- src/process_output.rs (200+ 行)
- src/storage.rs (344 行)
- CHANGELOG.md

**修改文件：**
- Cargo.toml
- src/main.rs
- src/daemon.rs
- src/config.rs
- src/cli.rs

**备份文件：**
- Cargo.toml.backup
- src/main.rs.backup
- src/config.rs.backup
- src/cli.rs.backup

---

## [0.1.0] - 2026-02-14

### Added

- 初始版本
- 基础进程管理功能
- CLI 命令接口
- 配置文件支持
- 信号处理
- PID 文件管理

---

*Generated by 星尘 (OpenClaw AI Assistant)*
*Last updated: 2026-02-28 21:15*
